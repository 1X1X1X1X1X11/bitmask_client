- Refactor mail connections to use state machine. Closes: #4059
